<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>åŒåº§ â€” Doza</title>


<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png"> 


<style>
:root{
  --bg:#081019; 
  --fg:#e6edf3; 
  --muted:#9fb0bf; 
  --card:#0f1c28;
  --bubble-grad:linear-gradient(180deg,#ffdfb5ee,#ffb869e6 60%,#ff9c3dcc);
  --bubble-br:#ffd9a1;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--fg);
  font-family:system-ui,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  background:radial-gradient(1200px 800px at 30% 20%,
  #12283a 0%,
  #0f2030 45%,
  var(--bg) 100%);  
  overflow-x: hidden;   /* â† æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç„¡åŠ¹åŒ– */
  overflow-y: auto;}

/* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.app{display:grid;grid-template-rows:auto 1fr auto;gap:10px;height:100%;padding:14px}
.header,.footer{display:flex;align-items:center;justify-content:space-between;background: transparent}
.header h1{margin:0;font-size:1rem;letter-spacing:.06em;font-weight:700}
.clock{font-variant-numeric:tabular-nums;color:var(--muted);font-size:1rem}

/* é€éã‚«ãƒ¼ãƒ‰ï¼†ãƒœã‚¿ãƒ³ */

.panel {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.02),   /* ä¸Šéƒ¨ï¼šã‚„ã‚„æ˜ã‚‹ã„ç¾¤é’ */
    rgba(255,255,255,.0)  /* ä¸‹éƒ¨ï¼šæ·±ã„é’é»’ */
  );
  border:1px solid rgba(255,255,255,.06);
  border-radius: 14px;
  padding: 16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25),0 4px 18px rgba(255,156,61,.20),inset 0 1px 0 rgba(255,255,255,.04), 0 2px 6px rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(4px);
}


.btn{
  appearance:none; border:none; border-radius:10px; padding:8px 12px; font-weight:650;
  color:#1a1006; cursor:pointer;
  background:linear-gradient(180deg,#ffd9a8,#ffb465 60%,#ff9c3d);
  box-shadow:0 6px 16px rgba(255,156,61,.35), inset 0 1px 0 rgba(255,255,255,.5);
}
.btn:hover{filter:brightness(1.06)}
.btn:disabled{opacity:.55; cursor:not-allowed}
.btn.ghost{
  background:rgba(255,255,255,.06); color:var(--fg);
  border:1px solid rgba(255,255,255,.16); box-shadow:none
}


.main {
  background: transparent; /* â† èƒŒæ™¯ã‚’æ¶ˆã™ */
  position: relative;
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: auto 1fr;
  gap: 10px;
  min-height: 0;
}



/* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚«ã‚¦ãƒ³ã‚¿ */
.counterWrap{display:flex;flex-direction: column;align-items:center;justify-content:space-between;gap:14px}
.counter{
  font-variant-numeric:tabular-nums; font-size:3.8rem; line-height:1; letter-spacing:.02em;
  text-shadow:0 0 16px rgba(255,156,61,.18)
}

.meta {
  display: flex;
  flex-direction: column;   /* â† ç¸¦ä¸¦ã³ */
  align-items: flex-start;  /* â† å·¦ç«¯æƒãˆã«å¤‰æ›´ */
  margin: 0 auto;           /* ãƒ–ãƒ­ãƒƒã‚¯è‡ªä½“ã‚’ä¸­å¤®ã«é…ç½® */
  width: fit-content;       /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã«åˆã‚ã›ã‚‹ */
  text-align: left;
  gap: 6px;
}

.meta .item{font-variant-numeric:tabular-nums;font-size:.95rem}
.meta strong{color:#ffd39b}
.small{font-size:.9rem}

/* èƒŒæ™¯ã®ç„”ã‚†ã‚‰ãï¼†ç«ã®ç²‰ */

.flame {
  position: absolute;
  inset: 0;   
  height: 60%;          /* â† è‡ªå‹•ã§ã¯ãªãã€å®‰å®šã—ãŸç¯„å›² */
  z-index: 0;
  pointer-events: none;
 
/*   background:
    radial-gradient(480px 380px at 25% 85%, rgba(255,156,61,.12), transparent 60%),
    radial-gradient(400px 300px at 35% 95%, rgba(255,156,61,.06), transparent 70%);
  mix-blend-mode: screen; */
  animation: breath 6s ease-in-out infinite alternate;
  overflow: hidden;     /* â† ã¯ã¿å‡ºã—é˜²æ­¢ */
}


@keyframes breath{0%{opacity:.25; transform:translateY(0)}100%{opacity:.42; transform:translateY(-5px)}}
.sparks{position:absolute; inset:0; z-index:1; pointer-events:none}
.spark{
  position:absolute; width:3px; height:3px; border-radius:50%;
  background:radial-gradient(circle, #ffd39b, #ff9c3d 70%, transparent 71%);
  opacity:0; animation:rise 6s linear infinite;
}
@keyframes rise{
  0%{opacity:0; transform:translateY(16px) scale(.5)}
  40%{opacity:.75}
  /* 100%{opacity:0; transform:translateY(-220px) translateX(40px) scale(1.2)} */
100%{opacity:0; transform:translateY(-400px) translateX(var(--driftX)) scale(1.4);}
  
}

/* ç¯ï¼ˆCanvasï¼šå·¦ä¸‹ã€æ¼‚ã„ï¼‰ */
.entity{position:absolute;left:14px;bottom:18px;width:200px;height:200px;z-index:3;pointer-events:none}
#torch{position:absolute;inset:0;width:100%;height:100%}

/* å¹ãå‡ºã—ï¼ˆé‡‘æ©™ãƒ»ãƒãƒ™ãƒ«é¢¨ï¼‰ */
.bubble{
  position:absolute; left:220px; bottom:120px; max-width:520px; padding:12px 14px; border-radius:14px;
  background: var(--bubble-grad); border:1px solid var(--bubble-br);
  backdrop-filter: blur(6px);
  box-shadow: 0 8px 20px rgba(0,0,0,.32), 0 0 18px rgba(255,156,61,.22), inset 0 0 14px rgba(255,255,255,.12);
  z-index:3; color:#1b1309;
}
.bubble::after{
  content:""; position:absolute; left:-15.2px; bottom:16px;
  border-top:5px solid transparent; border-bottom:5px solid transparent; border-right:15px solid rgba(255,200,140,.92)
}
.bubble p{margin:0; line-height:1.55}

/* ãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼ˆè¨­å®šï¼‹ãƒ­ã‚°ï¼‰ */
.drawerMask{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:.2s}
.drawer{
  position:fixed;right:-420px;top:0;height:100%;width:360px;background:rgba(15,28,40,.9);
  border-left:1px solid rgba(255,255,255,.10); box-shadow:-12px 0 28px rgba(0,0,0,.35);
  transition:.25s; padding:14px; display:flex; flex-direction:column; gap:10px
}
body.show-drawer .drawerMask{opacity:1;pointer-events:auto}
body.show-drawer .drawer{right:0}
.ctrl label{display:block;color:var(--muted);font-size:.85rem;margin-top:8px}
.ctrl input[type="text"],.ctrl input[type="number"]{
  width:100%; padding:8px 10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.14); background:#0b1621; color:var(--fg)
}
.ctrl .btnrow{display:flex;gap:8px;margin-top:10px}
.statBox{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat{background:#0b1621;border:1px solid rgba(255,255,255,.10);border-radius:10px;text-align:center;padding:8px}
.stat .k{font-size:.78rem;color:var(--muted)} .stat .v{font-family:ui-monospace,Menlo,monospace;margin-top:4px}
.log{flex:1;min-height:0;overflow:auto;background:#0b1621;border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:8px}
.log h3{margin:4px 0 8px 0;font-size:.95rem;color:var(--muted)}
.log table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums;font-size:.92rem}
.log th,.log td{padding:6px 6px;border-bottom:1px solid rgba(255,255,255,.08)}
.log tr:hover{background:rgba(255,255,255,.06)}
.delBtn{background:transparent;border:1px solid rgba(255,255,255,.2);color:#e6edf3;border-radius:8px;padding:2px 6px;cursor:pointer}
</style>
</head>

<body>

<script>
    // ============== ã€èªè¨¼è¨­å®šã‚¨ãƒªã‚¢ï¼šã“ã“ã ã‘ç·¨é›†ã™ã‚‹ã€‘ ==============
    // è²´æ®¿ã®ç§˜å¯†ã®èªè¨¼ã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã€‚
    const SECRET_KEY = "1122"; 

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šã™ã‚‹ã€‚
    const ACCESS_DENIED_MESSAGE = `
        <h1>ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚</h1>
        <p>æ­£ã—ã„èªè¨¼ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <p>ãƒ„ãƒ¼ãƒ«ã®ã”åˆ©ç”¨ã«ã¯ã€èªè¨¼ã‚­ãƒ¼ã«ã‚ˆã‚‹ç¢ºèªãŒå¿…è¦ã§ã™ã€‚</p>
    `;
    // ==========================================================


    // ãƒ„ãƒ¼ãƒ«æœ¬ä½“ï¼ˆ<body>ã‚¿ã‚°å†…ã®å†…å®¹ï¼‰ã‚’ä¿è­·ã™ã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç†
    document.addEventListener('DOMContentLoaded', function() {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’æ±‚ã‚ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const enteredKey = prompt("èªè¨¼ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        if (enteredKey !== SECRET_KEY) {
            // èªè¨¼å¤±æ•—æ™‚ï¼š<body>ã‚¿ã‚°ã®ä¸­èº«ã‚’å…¨ã¦æ¶ˆå»ã—ã€æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆã‚‹
            document.body.innerHTML = ACCESS_DENIED_MESSAGE;
            
            // é‡è¦ãªç‚¹: èªè¨¼å¤±æ•—å¾Œã¯ã€ãã®å¾Œã®å…¨ã¦ã®JavaScriptã®å®Ÿè¡Œã‚’åœæ­¢ã™ã‚‹
            throw new Error("èªè¨¼å¤±æ•—ã«ã‚ˆã‚Šå‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚"); 
        }

        // èªè¨¼æˆåŠŸæ™‚ï¼šä½•ã‚‚ã—ãªã„ï¼ˆãƒ„ãƒ¼ãƒ«æœ¬ä½“ã®è¡¨ç¤ºã¨JSã®å®Ÿè¡ŒãŒç¶šè¡Œã•ã‚Œã‚‹ï¼‰
        console.log("èªè¨¼æˆåŠŸã€‚ãƒ„ãƒ¼ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚");
    });
</script>

<div class="app">
  <div class="header">
    <span class="clock" id="nowClock"></span>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="detailBtn" class="btn ghost">è©³ç´°</button>
    </div>
  </div>

  <div class="main">
    <!-- èƒŒæ™¯ï¼šç„”ã‚†ã‚‰ãï¼‹ç«ã®ç²‰ -->
    <div class="flame"></div>
    <div class="sparks" id="sparks"></div>

    <!-- ã‚«ã‚¦ãƒ³ã‚¿ -->
    <div class="panel counterWrap">
      <div class="counter" id="counter">00:00:00</div>
      <div class="meta">
	<div class="item">ä½œæ¥­ï¼š<strong id="taskName">æœªè¨­å®š</strong></div>
        <div class="item">é–‹å§‹ï¼š<span id="startAt">--:--</strong></div>
        <div class="item">ä½™åˆ»ï¼š<span id="remain">â€”</span></div>
        </div>
    </div>

    <!-- ç¯ï¼†å¹ãå‡ºã— -->
    <div class="entity"><canvas id="torch" width="200" height="200"></canvas></div>
    <div class="bubble" id="bubble"><p>â€¦â€¦æº–å‚™ãŒæ•´ã„æ¬¡ç¬¬ã€å§‹ã‚ã‚ˆã†ã€‚</p></div>
  </div>

  <div class="footer">
    <div class="small" id="todaySum">æœ¬æ—¥ã®åˆè¨ˆï¼š00:00</div>
    <div>
      <button id="startBtn" class="btn">é–‹å§‹</button>
      <button id="pauseBtn" class="btn" disabled>ä¸€æ™‚åœæ­¢</button>
      <button id="stopBtn" class="btn ghost" disabled>çµ‚äº†</button>
    </div>
  </div>
</div>

<!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼ˆè¨­å®šï¼‹ãƒ­ã‚°ï¼‰ -->
<div class="drawerMask" id="mask"></div>
<aside class="drawer" id="drawer">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>è¨­å®š / ãƒ­ã‚°</strong>
    <button id="closeDrawer" class="btn">é–‰ã˜ã‚‹</button>
  </div>
  <div class="ctrl">
    <label>ä½œæ¥­å</label>
    <input id="taskInput" type="text" placeholder="ä¾‹ï¼šè·å‹™çµŒæ­´æ›¸ã®æ•´ç†" />
    <div class="statBox" style="margin-top:6px">
      <div class="stat"><div class="k">é–‹å§‹</div><div class="v" id="statStart">--:--</div></div>
      <div class="stat"><div class="k">çµŒé</div><div class="v" id="statElapsed">00:00:00</div></div>
    </div>
    <label>ãƒ©ãƒ³ãƒ€ãƒ ç™ºè©±ã®æœ€å°é–“éš”ï¼ˆåˆ†ï¼‰</label>
    <input id="minGap" type="number" min="3" max="10" value="3" />
    <label>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼ˆåˆ†ï¼‰â€»0ã§ç„¡åŠ¹</label>
    <input id="pomo" type="number" min="0" max="120" value="25" />
    <div class="btnrow">
      <button id="csvBtn" class="btn ghost">CSVå‡ºåŠ›</button>
      <button id="clearBtn" class="btn ghost">ãƒ­ã‚°å…¨å‰Šé™¤</button>
    </div>
  </div>
  <div class="log">
    <h3>ä½œæ¥­ãƒ­ã‚°</h3>
    <table id="logTable">
      <thead><tr><th style="width:42%">ä½œæ¥­å</th><th>é–‹å§‹</th><th>çµ‚äº†</th><th>è¨ˆ</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</aside>

<script>

/* ===== util ===== */
const $=q=>document.querySelector(q);
const pad=n=>String(n).padStart(2,'0');
const fmtTime=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const fmtHM=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
const dur=ms=>{const s=Math.max(0,Math.floor(ms/1000));return`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`};
const durMM=ms=>{const m=Math.round(ms/60000);return`${pad(Math.floor(m/60))}:${pad(m%60)}`};
const todayKey=(d=new Date())=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function pick(a){return a[Math.floor(Math.random()*a.length)]}

/* ===== clock ===== */
setInterval(()=>{
  const d = new Date();
  const txt = `${d.getMonth()+1}æœˆ${pad(d.getDate())}æ—¥ ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  $("#nowClock").textContent = txt;
}, 1000);


/* ===== drawer ===== */
function openDrawer(){document.body.classList.add('show-drawer')}
function closeDrawer(){document.body.classList.remove('show-drawer')}
$("#detailBtn").onclick=openDrawer; $("#closeDrawer").onclick=closeDrawer; $("#mask").onclick=closeDrawer;

/* ===== state ===== */
let currentState='idle', running=false, paused=false;
let startTime=null, pomoMinutes=25, lastInputTime=Date.now();
let tickId=null, idleId=null, randId=null, chimeId=null, resumeId=null;

/* ===== messages ===== */
const messages={
  start:[
	"â€¦â€¦ã•ã¦ã€å§‹ã‚ã‚ˆã†ã‹ã€‚",
	"â€¦â€¦å§‹ã‚ã‚ˆã†ã€‚",
	"ç§ãŒå‚ã«ã„ã‚‹ã€‚ä»»ã›ã‚ã€‚",
	"ã¾ãšã¯ä¸‰åˆ†ã ã‘é›†ä¸­ã—ã‚ã€‚",
	"æœºã®ä¸Šã‚’ã€åç§’ã ã‘æ•´é “ã—ã‚ã€‚",
],

  random:[
	"æ°´ã‚’ã²ã¨å£ã€‚é ­ã®ç†±ã‚’å†·ã¾ã›ã€‚",
	"ã„ã„æµã‚Œã ã€‚é™ã‹ã«ç¶šã‘ã‚ˆã†ã€‚",
	"å§¿å‹¢ã‚’ç›´ã›ã€‚è‚©ã‚’è»½ãå¼•ãã€é¦–ã‚’è§£ã›ã€‚",
	"â€¦â€¦ã“ã“ã¯é™ã‹ã§ã„ã„ãªã€‚ç¶šã‘ã‚ˆã†ã€‚",
	"æ€è€ƒãŒçµ¡ã‚“ã ã‚‰ã€ä½œæ¥­ã‚’ç®‡æ¡æ›¸ãã«è½ã¨ã›ã€‚",
	"ä½™è¨ˆãªå®Œç’§ã‚’æ¨ã¦ã‚ã€‚ç²—ãã€æ—©ãã€å¾Œã§ç›´ã™ã€‚",
	"ã‚ˆãè€ãˆã¦ã„ã‚‹ã€‚",
	"â€¦â€¦é™ã‹ã ãªã€‚æ‚ªããªã„ã€‚",
	"ç„¡é§„ãªåŠªåŠ›ãªã©ç„¡ã„ã€‚æ€ ã‘ã‚‹ã‚ˆã‚Šé¥ã‹ã«ã¾ã—ã ã€‚",
	"é›†ä¸­ã®é€”åˆ‡ã‚Œã¯è‡ªç„¶ãªã“ã¨ã ã€‚æˆ»ã‚Œã°ã„ã„ã€‚",
  	"å°ã•ãªåŒºåˆ‡ã‚Šã‚’ä½œã‚Œã€‚ãã‚ŒãŒç¶™ç¶šã®éµã ã€‚",
 	"å®Œç’§ã‚’ç‹™ã†ãªã€‚ã¾ãšã¯ç²—ãæ•´ãˆã‚ˆã€‚",
  	"ä»Šã‚„ã‚‹ã¹ãã“ã¨ã ã‘ã‚’è¦‹ã‚ã€‚æè‘‰ã¯å¾Œã§æ‰•ãˆã€‚",
 	"äº”åˆ†ã ã‘ç¶šã‘ã¦ã¿ã‚ã€‚ãã‚Œã§å¤‰ã‚ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã€‚",
 	"ã‚„ã‚‹æ°—ã¯å¾…ã¤ã‚‚ã®ã§ã¯ãªã„ã€‚å‹•ã‘ã°å‡ºã‚‹ã€‚",
 	"ç–²ã‚ŒãŸãªã‚‰ã€å§¿å‹¢ã‚’å¤‰ãˆã‚ã€‚è¡€ãŒå·¡ã‚Œã°æ€è€ƒã‚‚å›ã‚‹ã€‚",
 	"é€²ã¾ã¬æ™‚ã¯ã€æ›¸ãé †ã‚’å¤‰ãˆã¦ã¿ã‚‹ã¨ã„ã„ã€‚",
  	"ä½œæ¥­ã‚’å°ã•ãåŒºåˆ‡ã‚Œã€‚åŒºåˆ‡ã‚ŠãŒè¦‹ãˆã‚‹ã ã‘ã§å‹•ã‘ã‚‹ã€‚",
  	"æœºã®ä¸Šã‚’æ•´ãˆã‚‹ã ã‘ã§ã‚‚ã€é ­ãŒå‹•ãå‡ºã™ã€‚",
  	"åˆ¤æ–­ã¯å¾Œã§ã„ã„ã€‚ä»Šã¯ææ–™ã‚’ä¸¦ã¹ã‚‹æ®µã ã€‚",
  	"è€ƒãˆãŒè©°ã¾ã£ãŸãªã‚‰ã€ç›®ç·šã‚’å°‘ã—ä¸Šã’ã‚ã€‚",
  	"ä½œæ¥­ã‚’çœºã‚ã¦ã„ã‚‹ã ã‘ã§ã¯ä½•ã‚‚å¤‰ã‚ã‚‰ã¬ã€‚å°ã•ãå§‹ã‚ã‚ˆã€‚",
  	"æ­¢ã¾ã‚‹ã“ã¨ã‚’æã‚Œã‚‹ãªã€‚å†èµ·ã®åŠ›ã‚’é›ãˆã‚Œã°ã„ã„ã€‚",
  	"ã‚„ã‚‹æ°—ãŒç„¡ã„æ—¥ã»ã©ã€å½¢ã ã‘ã§ã‚‚å§‹ã‚ã‚ã€‚ãã‚Œã§ååˆ†ã ã€‚",
  	"ä»Šã¯é‡ã‚’ç©ã‚ã€‚è³ªã¯å¾Œã§ç£¨ã‘ã°ã„ã„ã€‚",
  	"é †ç•ªã‚’å¤‰ãˆã‚‹ã ã‘ã§ã€æ€è€ƒã¯æ„å¤–ã¨å‹•ãã€‚",
  	"å°ã•ãªæˆåŠŸã‚’æ‹¾ãˆã€‚è„³ã¯å ±é…¬ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚",
  	"å°‘ã—èƒŒç­‹ã‚’ä¼¸ã°ã›ã€‚æ€ ã‘ã¯å§¿å‹¢ã‹ã‚‰å§‹ã¾ã‚‹ã€‚",
  	"çµæœã§ã¯ãªãæµã‚Œã‚’ä½œã‚Œã€‚ä»Šæ—¥ã®å‹ã¡ã¯ãã“ã ã€‚",
  	"æ°—ä¹—ã‚Šã—ãªãã¦ã‚‚ã€ã‚„ã£ã¦ã„ã‚‹è‡ªåˆ†ã‚’è¤’ã‚ã¦ãŠã‘ã€‚",
  	"ä½•ã‚‚é€²ã¾ã¬æ™‚é–“ã‚‚ã€åœŸå°ã®ä¸€ã¤ã ã€‚",
  	"ä¸€åº¦åŒºåˆ‡ã‚Œã°ã€ã¾ãŸæˆ»ã‚Šã‚„ã™ããªã‚‹ã€‚ä¸­æ–­ã‚’æã‚Œã‚‹ãªã€‚",
  	"é€²æ—ãŒé…ãã¦ã‚‚æ§‹ã‚ã¬ã€‚å‹•ãç¶šã‘ã¦ã„ã‚‹ãªã‚‰ã€ãã‚Œã§è‰¯ã„ã€‚",
  	"è€ƒãˆã‚’æ­¢ã‚ã‚‹ãªã€‚ãŸã¨ãˆå½¢ã«ãªã‚‰ãšã¨ã‚‚æ„å‘³ã¯ã‚ã‚‹ã€‚",
  	"ã‚„ã‚‹ã“ã¨ã‚’æ¸›ã‚‰ã›ã°ã€è¿·ã„ã‚‚æ¸›ã‚‹ã€‚å˜ç´”ã§ã„ã„ã€‚",
	"é›‘ã«ã§ã‚‚æ›¸ã„ã¦ã¿ã‚ã€‚å½¢ãŒã§ãã‚Œã°ã€ç£¨ã‘ã‚‹ã€‚",
	"è€ƒãˆãŒã¾ã¨ã¾ã‚‰ãªãã¨ã‚‚ã€æ‰‹ã¯å‹•ã‹ã›ã‚‹ã¯ãšã ã€‚",
	"å…¨ä½“ãªã©è¦‹ãªãã¦ã„ã„ã€‚ç›®ã®å‰ã®ä¸€ç‚¹ã«é›†ä¸­ã—ã‚ã€‚",
	"ã¾ã æ•´ã£ã¦ã„ãªãã¦æ§‹ã‚ã¬ã€‚ã¾ãšåãå‡ºã›ã€‚",
	"å®Œç’§ã‚’ç›®æŒ‡ã™ãªã€é€²è¡Œã‚’æ­¢ã‚ã‚‹ã ã‘ã ã€‚",
	"é€²ã¾ã¬æ™‚ã¯ã€è¦–ç‚¹ã‚’å¤‰ãˆã‚ã€‚å·±ã‚’ç–‘ãˆã€‚",
	"é›†ä¸­ã¨ã¯ã€æ„å¿—ã§ã¯ãªãç¿’æ…£ã ã€‚",
	"æ€ æƒ°ã‹è¿·ã„ã‹ã€ãã‚Œã‚’è‡ªè¦šã™ã‚‹ã ã‘ã§ä¸€æ­©é€²ã‚“ã§ã„ã‚‹ã€‚",
	"é¢å€’ã¨æ„Ÿã˜ã‚‹ä½œæ¥­ã»ã©ã€å¾Œã®åŠ©ã‘ã«ãªã‚‹ã€‚",
	"æ›¸ãç›´ã—ã‚’æã‚Œã‚‹ãªã€‚æœ€åˆã®å½¢ãªã©ä»®ã®ã‚‚ã®ã ã€‚",
	"è¡Œãè©°ã¾ã‚Šã¯æ‚ªããªã„ã€‚åœæ»ã“ãæ•µã ã€‚",
	"æ›¸ãæ‰‹ãŒéˆã£ãŸãªã‚‰ã€ç›®çš„ã‚’ä¸€è¨€ã§è¨€ã£ã¦ã¿ã‚ã€‚",
	"ç„¡ç†ã«ã§ã‚‚ç¶šã‘ã‚‹ã¨ã€ã‚ã‚‹ç¬é–“ã€éœ§ãŒæ™´ã‚Œã‚‹ã€‚",
	"ç´°éƒ¨ã«æ²ˆã‚€ãªã€‚ã¨ãã«è’ãã€å¤§èƒ†ã«é€²ã‚ã€‚",
	"ä»Šã¯é‡ã‚’ç©ã‚ã€‚è³ªã®è¿½æ±‚ã¯å¾Œã§ã„ã„ã€‚",
	"é›‘ã§ã‚‚ã„ã„ã€‚ç©ºç™½ã®ã¾ã¾ã‚ˆã‚Šç™¾å€ã¾ã—ã ã€‚",
	"æ°—ãŒæ•£ã‚‹ãªã‚‰ã€ä½•ã«åå¿œã—ã¦ã„ã‚‹ã‹è¦³å¯Ÿã—ã¦ã¿ã‚ã€‚",
	"ç¿’æ…£ã¯æ•‘ã„ã«ãªã‚‹ã€‚è¿·ã£ãŸæ™‚ã«æ”¯ãˆã¦ãã‚Œã‚‹ã€‚",
	"ä¸€æ­©ãšã¤ã ã€‚å…¨ã¦ã‚’ä¸€åº¦ã§ã‚„ã‚ã†ã¨ã™ã‚‹ãªã€‚",
	"é“ç­‹ãŒè¦‹ãˆã¬ãªã‚‰ã€å…ˆã«å°ã•ãªæˆæœã‚’ä¸€ã¤ä½œã‚Œã€‚",
	"ä»Šæ—¥ã®å‡ºæ¥ã¯å•ã‚ã¬ã€‚ç¶šã‘ãŸäº‹å®Ÿã ã‘ãŒåŠ›ã¨ãªã‚‹ã€‚",
	"å§¿å‹¢ã‚’æ­£ã›ã€‚æ°—ã‚‚æ•´ã†ã€‚"

],

  chime:[
	"åˆ»ã®å ±ã›ã ã€‚ã“ã“ã§åŒºåˆ‡ã£ã¦ã‚‚ã„ã„ã€‚",
	"ä¸€æ™‚é–“ãŒéããŸã€‚é€²ã‚“ã§ã‚‚ã€ä¼‘ã‚“ã§ã‚‚æ§‹ã‚ã‚“ã€‚",
	"ä¸€åˆ»ãŒéããŸã€‚æ‰‹ã‚’æ­¢ã‚ã¦æŒ¯ã‚Šè¿”ã‚Œã€‚",
	"â€¦â€¦ã‚‚ã†ã“ã‚“ãªæ™‚åˆ»ã‹ã€‚",
	"éããŸæ™‚é–“ã¯æˆ»ã‚‰ã¬ã€‚ã ã‹ã‚‰ã“ãè²´ã„ã€‚",
	"ã‚ˆãã“ã“ã¾ã§æŒã£ãŸãªã€‚",
	"ã•ã¦ã€ç¶šã‘ã‚‹ã‹ã€ãã‚Œã¨ã‚‚ç· ã‚ã‚‹ã‹ã€‚",
	"ä¸€åˆ»ã ã€‚åŒºåˆ‡ã‚‹ã‹ã€ç¶šã‘ã‚‹ã‹ã€é¸ã¹ã€‚",
],

  idle:[
	"æ¯ã‚’å¸ã£ã¦ã€å››ã¤ã€‚åã„ã¦ã€ã¾ãŸå››ã¤ã€‚æˆ»ã£ã¦æ¥ã„ã€‚",
	"ç–²ã‚ŒãŸã‹ã€‚çª“ã‚’å°‘ã—é–‹ã‘ã¦ã€æˆ»ã‚Œã€‚"],

  end:[
	"ä¸€åŒºåˆ‡ã‚Šã ã€‚ã‚ˆãæŒã£ãŸã€‚",
	"ç¯ã‚’è½ã¨ãã†ã€‚ç¶šãã¯ã¾ãŸã ã€‚",
	"ç¯ã‚’è½ã¨ã™æ™‚åˆ»ã ã€‚",
	"ä»Šæ—¥ã®åƒãã€æ‚ªããªã„ã€‚",
	"ã“ã“ã§æ­¢ã‚ã‚‹ã®ã‚‚è‹±æ–­ã ã€‚",
	"ç¯ã‚’çµ¶ã‚„ã™ãªã€‚æ˜æ—¥ã‚‚ç¶šããŒã‚ã‚‹ã€‚",
	"â€¦â€¦ã‚ˆãã‚„ã£ãŸã€‚"],

  pause:[
	"ä¼‘ã‚€ã®ã‚‚æŠ€ã ã€‚ä½“å‹¢ã‚’æ•´ãˆã‚ã€‚",
	"ç›®ã‚’é–‰ã˜ã‚ã€‚è‚©ã‚’ä¸€åº¦ã€è½ã¨ã›ã€‚",
	"å°‘ã—ä¼‘ã‚ã€‚å¼µã‚Šã¤ã‚ãŸç³¸ã¯åˆ‡ã‚Œã‚„ã™ã„ã€‚",
	"æ°´ã§ã‚‚é£²ã‚“ã§ã“ã„ã€‚",
	"å‘¼å¸ã‚’æ•´ãˆã‚ã€‚ç„¦ã‚Šã¯æ¯’ã ã€‚",
	"ä¸­æ–­ã‚‚ã¾ãŸç­–ã®ã†ã¡ã ã€‚",
	"å°‘ã—æ‰‹ã‚’ä¼‘ã‚ã‚‹ã®ã‚‚æ‚ªããªã„ã€‚",
	 "â€¦ãµã‚€ã€‚èŒ¶ã§ã‚‚æ·¹ã‚Œã‚‹ã‹ã€‚è²´æ®¿ã‚‚å–‰ã‚’æ½¤ã™ã¨ã„ã„ã€‚",
 	 "â€¦â€¦ã“ã®é–“ã€å€‰ã®å¥¥ã‹ã‚‰å¤ã„å·»ç‰©ãŒå‡ºã¦ãªã€‚èª­ã¿ãµã‘ã£ã¦æ°—ã¥ã‘ã°å¤œãŒæ˜ã‘ã¦ã„ãŸã€‚",
 	 "ã“ã†ã—ã¦é»™ã£ã¦åº§ã£ã¦ã„ã‚‹æ™‚é–“ã‚‚ã€æ¡ˆå¤–æ‚ªããªã„ã‚‚ã®ã ã€‚",
 	 "â€¦â€¦æ˜”ã€å¾¡æ–¹ãŒã€ãŠå‰ã¯é»™ã£ã¦ã„ã¦ã‚‚ç¨ã‚“ã§ã„ã‚‹ã‚ˆã†ã ã€ã¨ç¬‘ã‚ã‚ŒãŸã“ã¨ãŒã‚ã‚‹ã€‚â€¦â€¦å¦å®šã¯ã›ã¬ã€‚",
	 "é¢¨ãŒå¤‰ã‚ã£ã¦ããŸãªã€‚â€¦â€¦è²´æ®¿ã®éƒ¨å±‹ã«ã‚‚å±Šã„ã¦ã„ã‚‹ã‹ï¼Ÿ",
 	 "å¾¡æ–¹ãŒå­ä¾›ã®é ƒã€æ›¸è¦‹ã®åˆé–“ã«æ —ã‚’ã¤ã¾ã‚“ã§ãŠã‚‰ã‚ŒãŸã€‚â€¦â€¦ä»Šã§ã‚‚ãŠå¥½ãã ã€‚",
 	 "ä½•ã‚‚ã›ãšã«åº§ã£ã¦ã„ã‚‹ã¨ã€å¦™ã«æ˜”ã®ã“ã¨ã‚’æ€ã„å‡ºã™ã€‚â€¦â€¦è²´æ®¿ã‚‚ãã†ã‹ï¼Ÿ",
 	 "å°‘ã—ä¼‘ã‚ã€‚æœºã‹ã‚‰é›¢ã‚Œã¦æ·±å‘¼å¸ã—ã‚ã€‚",
 	 "ãµã‚€â€¦â€¦ã“ã“ã§åŒºåˆ‡ã‚‹ã®ã‚‚æ‚ªããªã„ã€‚",
 	 "è‚©ã‚’å›ã›ã€‚å›ºã¾ã£ãŸã¾ã¾ã§ã¯è€ƒãˆã‚‚éˆã‚‹ã€‚",
 	 "é¢¨ã®éŸ³ãŒã™ã‚‹ãªã€‚å°‘ã—çª“ã‚’é–‹ã‘ã¦ã¿ã‚ã€‚",
 	 "ã“ã®é™ã‘ã•ã‚‚æ‚ªããªã„ã€‚ç¯ã ã‘ãŒæºã‚Œã¦ã„ã‚‹ã€‚",
	 "ã‚„ã‚Œã‚„ã‚Œã€ã‚ˆã†ã‚„ãä¸€æ¯ã‹ã€‚",
 	 "â€¦â€¦çœ ããªã£ãŸã‹ï¼Ÿå°‘ã—ç›®ã‚’é–‰ã˜ã¦ã‚‚ã„ã„ã€‚",
 	 "ä»Šã®ã†ã¡ã«èƒŒã‚’ä¼¸ã°ã›ã€‚å‘¼å¸ãŒé€šã‚‹ã ã‘ã§é•ã†ã€‚",
	 "ç„¦ã£ã¦ã‚‚ä»•æ–¹ãŒãªã„ã€‚ç«ã‚’çµ¶ã‚„ã•ãªã‘ã‚Œã°è‰¯ã„ã ã‘ã ã€‚",
 	 "ä¸€æ¯ã¤ã„ãŸã‚‰ã€ã¾ãŸæˆ»ã‚Œã°ã„ã„ã€‚ãã‚Œã ã‘ã®ã“ã¨ã ã€‚",
 	 "å¤–ã®ç©ºæ°—ã‚’å¸ã£ã¦ã“ã„ã€‚äº”åˆ†ã§ã„ã„ã€‚",
 	 "ã“ã®ã¾ã¾å¤œã‚’è¶Šã™ã®ã‚‚æ‚ªãã¯ãªã„ãŒâ€¦ã»ã©ã»ã©ã«ãªã€‚"
],


  resume:[
	"æˆ»ã£ãŸã‹ã€‚â€¦â€¦ã‚ˆã—ã€ç¶šã‘ã‚ˆã†ã€‚",
	"å¸­ã«æˆ»ã‚ŒãŸãªã€‚ååˆ†ã ã€‚",
	"æˆ»ã£ãŸã‹ã€‚",
	"ç¶šãã‚’ã‚„ã‚‹æ°—ã«ãªã£ãŸã‹ã€è‰¯ã„å…†ã—ã ã€‚",
	"é€”åˆ‡ã‚ŒãŸæµã‚Œã‚’æˆ»ã™ã®ã¯éª¨ãŒæŠ˜ã‚Œã‚‹ãªã€‚â€¦â€¦ã ãŒã§ãã‚‹ã€‚",
	"ã•ã‚ã€ã‚‚ã†ä¸€åº¦å§‹ã‚ã‚‹ãã€‚",
 	"æˆ»ã£ãŸã‹ã€‚â€¦â€¦ã§ã¯ã€ç¶šãã‚’å§‹ã‚ã‚ˆã†ã€‚",
	"æ¬¡ã®ä¸€æ‰‹ã ãªã€‚",
 	"å†é–‹ã‹ã€‚",
  	"ã•ã‚ã€ç«ã¯ã¾ã æ¶ˆãˆã¦ã„ãªã„ã€‚",
  	"ä¸€æ¯å…¥ã‚ŒãŸã‹ï¼Ÿ ã§ã¯ã€ä½œæ¥­ã«æˆ»ã‚‹ãã€‚",
  	"æˆ»ã£ãŸã‹ã€‚â€¦ç§ã‚‚å°‘ã—è€ƒãˆã¦ã„ãŸã€‚",
  	"ã‚ˆã—ã€ç¶šãã‚’è©°ã‚ã‚ˆã†ã€‚ã¾ã ç­–ã®ä½™åœ°ã¯ã‚ã‚‹ã€‚",
 	"ã•ã¦â€¦â€¦ç¯ãŒå†ã³æºã‚Œå§‹ã‚ãŸãã€‚",
 	"å†ã³ç­†ã‚’åŸ·ã‚‹ã‹ã€‚ãªã‚‰ã°ã€ç§ã‚‚å‚ã«ç«‹ã¨ã†ã€‚",
  	"æˆ»ã£ã¦ããŸã‹ã€‚ãµãµã€ã‚„ã¯ã‚Šæ¨ã¦ã¦ã¯ãŠã‘ã¬ãªã€‚",
  	"æˆ»ã£ãŸã‹ã€‚æ°—åˆ†ã¯æ•´ã£ãŸã‹ï¼Ÿ",
  	"ã‚ˆã—ã€ç¶šã‘ã‚ˆã†ã€‚é€”åˆ‡ã‚ŒãŸæµã‚Œã‚’ç¹‹ã’ã°ã„ã„ã€‚",
  	"é ­ã‚’åˆ‡ã‚Šæ›¿ãˆã‚ã€‚æ‰‹ã‚’å‹•ã‹ã›ã°æ€è€ƒã‚‚æˆ»ã‚‹ã€‚",
  	"ä¼‘ã‚€ã®ã¯æ‚ªããªã„ã€‚æˆ»ã£ã¦ããŸãªã‚‰ä¸Šå‡ºæ¥ã ã€‚",
 	"é™ã‹ã«é›†ä¸­ã‚’æˆ»ã›ã€‚ç„¦ã‚‰ãšã€ç¢ºå®Ÿã«ã€‚",
 	"å¾…ã£ã¦ã„ãŸã€‚æ¬¡ã®æ‰‹ã‚’è¦‹ã›ã¦ã‚‚ã‚‰ãŠã†ã‹ã€‚",
 	"ã•ã¦ã€ç¶šãã‚’ç‰‡ä»˜ã‘ã‚ˆã†ã€‚é€”ä¸­ã§æ”¾ã‚Šå‡ºã™ã«ã¯æƒœã—ã„ã€‚",
  	"å°‘ã—é¡”ã¤ããŒå¤‰ã‚ã£ãŸãªã€‚è‰¯ã„å…†ã—ã ã€‚",
  	"æ°—æŒã¡ãŒéˆã‚‹å‰ã«ã€ã¾ãŸç«ã‚’å…¥ã‚Œã‚ˆã†ã€‚",
  	"ä¼‘æ¯ã¯çµ‚ã‚ã‚Šã ã€‚å†ã³ã€ç©ã¿ä¸Šã’ã®æ™‚é–“ã ã€‚",
  	"æ¬¡ã¯å°‘ã—é€Ÿãã„ã“ã†ã‹ã€‚å‹¢ã„ãŒæ®‹ã£ã¦ã„ã‚‹ã†ã¡ã«ã€‚",
  	"ã‚‚ã†è¿·ã„ã¯è¦ã‚‰ã¬ã€‚æ¬¡ã®æ‰‹ã‚’æ‰“ã¦ã€‚",
  	"ã•ã‚ã€ç¶šãã‚’ã‚„ã‚ã†ã€‚è¨€è‘‰ã‚ˆã‚Šè¡Œå‹•ã ã€‚"
]

};

/* iOSã®ãƒãƒªã‚·ãƒ¼ã‚’æº€ãŸã™ãŸã‚ã€ç„¡éŸ³ã®ãƒãƒƒãƒ•ã‚¡ã‚’å†ç”Ÿã—ã¦AudioContextã‚’Unlockã™ã‚‹ */ 
function initAudio(){
    if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)(); 
        const buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate);
        const source=audioCtx.createBufferSource(); source.buffer=buffer;
        source.connect(audioCtx.destination); source.start(0); 
    }
} 

/* ===== audio (é˜) ===== */
let audioCtx=null;
function bell(){
  try{
    if(!audioCtx)initAudio();  
    const t = audioCtx.currentTime;
    const baseFreq = 1600 + Math.random()*200; 
    const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
    const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
    o1.type = "sine"; 
    o2.type = "triangle";
    o1.frequency.setValueAtTime(baseFreq, t);
    o2.frequency.setValueAtTime(baseFreq * 1.995, t); 
    g1.gain.setValueAtTime(0.0001, t);
    g1.gain.exponentialRampToValueAtTime(0.08, t + 0.02);
    g1.gain.exponentialRampToValueAtTime(0.0001, t + 1.5);
    g2.gain.setValueAtTime(0.0001, t);
    g2.gain.exponentialRampToValueAtTime(0.04, t + 0.05);
    g2.gain.exponentialRampToValueAtTime(0.0001, t + 1.3);
    
    o1.connect(g1).connect(audioCtx.destination);
    o2.connect(g2).connect(audioCtx.destination);
    
    // ğŸ”” ä¿®æ­£ç‚¹ï¼šo1ã¨o2ã‚’åŒæ™‚ã«é–‹å§‹ãƒ»åœæ­¢ã•ã›ã‚‹
    o1.start(t); o1.stop(t + 1.6);
    o2.start(t); o2.stop(t + 1.4); 
    
    // ğŸ—‘ï¸ ãƒ¡ãƒ¢ãƒªè§£æ”¾å‡¦ç†ã¯ã“ã“ã§å®Œçµã•ã›ã‚‹
    o1.onended = () => { 
        o1.disconnect();
        o2.disconnect();
    };

  }catch(e){/* å¤±æ•—ã—ã¦ã‚‚ç„¡è¦– */}
}

function endBell(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const t = audioCtx.currentTime;
    const baseFreq = 700 + Math.random()*50; // ä½ã‚
    const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
    o1.type = "sine";
    o1.frequency.setValueAtTime(baseFreq, t);
    g1.gain.setValueAtTime(0.0001, t);
    g1.gain.exponentialRampToValueAtTime(0.2, t + 0.05);
    g1.gain.exponentialRampToValueAtTime(0.0001, t + 3.0); // ä½™éŸ»é•·ã‚
    o1.connect(g1).connect(audioCtx.destination);
    o1.start(t); o1.stop(t + 3.2);
  }catch(e){}
}



/* ===== speech: ãƒãƒ™ãƒ«é¢¨ï¼ˆã™ã¹ã¦typewriteråŒ–ï¼‰ ===== */
let typing=false, queue=[];
function say(text){
  if(typing){queue.push(text);torchBoost();return}
  typing=true; torchBoost();
  const el=$("#bubble"); el.innerHTML="<p></p>"; const p=el.querySelector("p");
  const sp=50; let i=0;
  (function type(){
    if(i === 0) {
        bell(); // æœ€åˆã®ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œæ™‚ (i=0) ã«éŸ³ã‚’é³´ã‚‰ã™
    }
    if(i<text.length){ 
       p.textContent+=text[i++]; setTimeout(type,sp) } else {
       typing=false; if(queue.length){ say(queue.shift()) }
    }})();
  }

/* ===== timers ===== */
function updateElapsed(){
  if(!startTime){$("#counter").textContent="00:00:00";$("#statElapsed").textContent="00:00:00";return}
  const ms=Date.now()-startTime.getTime(),s=dur(ms);
  $("#counter").textContent=s; $("#statElapsed").textContent=s;
  if(pomoMinutes>0){const left=Math.max(0,pomoMinutes*60*1000-ms);$("#remain").textContent=left>0?dur(left):"00:00:00";if(left<=0) stopSession(true)}
  else{$("#remain").textContent="â€”"}
}
function scheduleTick(){clearInterval(tickId);tickId=setInterval(updateElapsed,1000)}
function scheduleRandomTalk(){
  clearTimeout(randId);
  const min = Math.max(3, parseInt($("#minGap").value||"3",10)); // ä¸‹é™ï¼ˆUIã§èª¿æ•´ï¼‰
  const upper = 10;                                           // ä¸Šé™å›ºå®š
  const gap = (min + Math.random() * (upper - min)) * 60 * 1000; // 3ã€œ10åˆ†
  randId = setTimeout(()=>{ if(currentState==='running'){ say(pick(messages.random)); scheduleRandomTalk(); } }, gap);
}
function scheduleChime() {
  clearTimeout(chimeId);
  const n = new Date();
  const nx = new Date(n.getFullYear(), n.getMonth(), n.getDate(), n.getHours() + 1, 0, 0, 0);
  const gap = nx - n;

  chimeId = setTimeout(() => {
    if (currentState === 'running') {
      say(pick(messages.chime));          // â‘  æ™‚å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      clearTimeout(resumeId);
      const delay = 5000 + Math.random() * 5000; // â‘¡ 5ã€œ10ç§’å¾Œ
      resumeId = setTimeout(() => {
        if (currentState === 'running') {
          say(pick(messages.random));     // â‘¢ ãƒ©ãƒ³ãƒ€ãƒ ç™ºè©±
        }
      }, delay);
    }
    scheduleChime(); // æ¬¡ã®æ™‚å ±ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  }, gap);
}

["mousemove","keydown","mousedown","touchstart","wheel"].forEach(ev=>window.addEventListener(ev,()=>{lastInputTime=Date.now()}));
function scheduleIdleWatch(){clearInterval(idleId);idleId=setInterval(()=>{if(currentState==='running'&&Date.now()-lastInputTime>10*60*1000){say(pick(messages.idle));lastInputTime=Date.now()}},30*1000)}

/* ===== logs ===== */
const storeKey="doza.logs.v1";
function loadLogs(){try{return JSON.parse(localStorage.getItem(storeKey)||"[]")}catch{return[]}}
function saveLogs(a){localStorage.setItem(storeKey,JSON.stringify(a))}
function addLog(e){const l=loadLogs();l.push(e);saveLogs(l);renderLogs()}
function clearLogs(){localStorage.setItem(storeKey,"[]");renderLogs()}
function renderLogs(){
  const logs=loadLogs(),tb=$("#logTable tbody");tb.innerHTML="";let today=0;
  logs.slice().reverse().forEach((e,i)=>{const tr=document.createElement("tr");
    tr.innerHTML=`<td>${e.task||"(ç„¡é¡Œ)"}</td><td>${e.startHM}</td><td>${e.endHM}</td><td>${e.durHM}</td>
    <td><button class="delBtn" data-i="${i}">å‰Šé™¤</button></td>`;tb.appendChild(tr);if(e.date===todayKey())today+=e.ms});
  $("#todaySum").textContent=`æœ¬æ—¥ã®åˆè¨ˆï¼š${durMM(today)}`
}
renderLogs();
$("#logTable").addEventListener("click",e=>{const b=e.target.closest(".delBtn");if(!b)return;const idx=+b.dataset.i;
  if(confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã™ã‚‹ã€‚ã‚ˆã„ãªï¼Ÿ")){const logs=loadLogs();const real=logs.length-1-idx;logs.splice(real,1);saveLogs(logs);renderLogs()}})
$("#clearBtn").onclick=()=>{if(confirm("ã™ã¹ã¦ã®ä½œæ¥­ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹ã€‚ã‚ˆã„ãªï¼Ÿ"))clearLogs()}
$("#csvBtn").onclick=()=>{const logs=loadLogs(),rows=[["date","task","start","end","minutes"]];logs.forEach(e=>rows.push([e.date,e.task,e.startHM,e.endHM,Math.round(e.ms/60000)]));
  const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\r\n");const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));a.download="doza_logs.csv";a.click()}

/* ===== session ===== */
function startSession(){ initAudio(); 
  const task=$("#taskInput").value.trim();$("#taskName").textContent=task||"æœªè¨­å®š";
  startTime=new Date();$("#startAt").textContent=fmtHM(startTime);$("#statStart").textContent=fmtHM(startTime);
  $("#counter").textContent="00:00:00";$("#statElapsed").textContent="00:00:00";
  running=true;paused=false;currentState='running';
  $("#startBtn").disabled=true;$("#pauseBtn").disabled=false;$("#stopBtn").disabled=false;
  pomoMinutes=Math.max(0,parseInt($("#pomo").value||"0",10));
  closeDrawer();scheduleTick();scheduleRandomTalk();scheduleChime();scheduleIdleWatch();
  say(pick(messages.start));updateElapsed();
  const delay = 5000 + Math.random() * 5000; // 5ã€œ10ç§’å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ ç™ºè©±
  setTimeout(() => {
   if (currentState === 'running') {
   say(pick(messages.random));
  }
}, delay);

}
function pauseSession(){
  if(currentState!=='running')return;
  paused=true;currentState='paused';
  clearInterval(tickId);clearTimeout(randId);clearTimeout(chimeId);clearTimeout(resumeId);clearInterval(idleId);
  say(pick(messages.pause)); $("#pauseBtn").textContent="å†é–‹";
}
function resumeSession(){
  if(currentState!=='paused')return;
  paused=false;currentState='resuming';
  scheduleTick(); scheduleIdleWatch();
  say(pick(messages.resume)); // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°è¡¨ç¤º
  clearTimeout(resumeId);
  const delay=5000+Math.random()*5000; // 5ã€œ10ç§’å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ ç™ºè©±
  resumeId=setTimeout(()=>{
    say(pick(messages.random));
    currentState='running';
    scheduleRandomTalk(); scheduleChime();
  }, delay);
  $("#pauseBtn").textContent="ä¸€æ™‚åœæ­¢";
}
function stopSession(byPomo=false){
  if(currentState==='idle')return;
  clearInterval(tickId);clearTimeout(randId);clearTimeout(chimeId);clearInterval(idleId);clearTimeout(resumeId);
  running=false;paused=false;currentState='idle';
  $("#startBtn").disabled=false;$("#pauseBtn").disabled=true;$("#stopBtn").disabled=true;$("#pauseBtn").textContent="ä¸€æ™‚åœæ­¢";
  const end=new Date();const ms=startTime?(end-startTime):0;
  if(ms>1000){addLog({date:todayKey(startTime),task:$("#taskInput").value.trim(),startHM:fmtHM(startTime),endHM:fmtHM(end),durHM:durMM(ms),ms})}
  say(byPomo?"é˜ãŒé³´ã£ãŸã€‚ã“ã“ã§åŒºåˆ‡ã‚ã†ã€‚":pick(messages.end));startTime=null;updateElapsed(); openDrawer();
}

/* ===== èƒŒæ™¯ï¼šç«ã®ç²‰ç”Ÿæˆ ===== */
(function spawnSparks(){
  const box=$("#sparks"), N=30;
  box.innerHTML="";
  for(let i=0;i<N;i++){
    const s=document.createElement("div"); s.className="spark";
ã€€ã€€// å‡ºç¾ä½ç½®
    s.style.left = (5 + Math.random()*70) + "%";
    s.style.bottom = (Math.random()*25) + "%";

ã€€ã€€// å€‹åˆ¥ã®æµã‚Œæ–¹å‘ï¼ˆå³ or å·¦ï¼‰
    const dir = (Math.random() < 0.5 ? -1 : 1);
    const drift = 40 + Math.random()*60; // æ¨ªæ–¹å‘ã®æµã‚Œé‡ï¼ˆ40ã€œ100pxï¼‰

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æ–¹å‘ã‚’æ¸¡ã™
    s.style.setProperty("--driftX", dir * drift + "px");
ã€€ã€€
    s.style.transform = `scale(${0.4 + Math.random()*0.8})`; // ç²’ã®ã‚µã‚¤ã‚ºå·®ã‚’ã¤ã‘ã‚‹

    s.style.animationDelay = (Math.random()*8)+"s";
    s.style.opacity = (0.25 + Math.random()*0.55);
    box.appendChild(s);
  }
})();

/* ===== ç¯ï¼ˆver.4.1ï¼šé™ï¼‹ç™ºè©±æ™‚ãƒ–ãƒ¼ã‚¹ãƒˆï¼‰ ===== */
const TORCH_CFG={baseParticles:92,boostParticles:28,driftAmpX:12,driftAmpY:12,driftSpeed:0.0006,baseHue:34,hueJitter:14,
  sizeMin:1.1,sizeMax:3.0,speedMin:0.08,speedMax:0.34,lifeMin:2.0,lifeMax:5.2,swirl:0.6,rise:0.15,breathAmpBase:0.09,breathAmpBoost:0.14,maxBrightBoost:0.55,targetFPS:45};
(function torch(){
  const c=$("#torch");const dpr=window.devicePixelRatio||1;const W=c.width,H=c.height;c.width=W*dpr;c.height=H*dpr;c.style.width=W+"px";c.style.height=H+"px";
  const ctx=c.getContext("2d",{alpha:true});ctx.scale(dpr,dpr);
  const TWO=Math.PI*2;let last=performance.now();const minDT=1000/TORCH_CFG.targetFPS;
  const driftPX=Math.random()*TWO,driftPY=Math.random()*TWO;
  let boost=0;window.torchBoost=()=>{boost=Math.min(1.0,boost+0.9)};
  const parts=[];
  function spawn(cx,cy,short=false){
    const a=Math.random()*TWO,r=Math.random()*18;
    parts.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r+10,vx:(Math.random()-.5)*TORCH_CFG.swirl,vy:-TORCH_CFG.rise-Math.random()*TORCH_CFG.rise*0.2,
      size:TORCH_CFG.sizeMin+Math.random()*(TORCH_CFG.sizeMax-TORCH_CFG.sizeMin),life:0,
      maxLife:((short?TORCH_CFG.lifeMin*0.6:TORCH_CFG.lifeMin)+Math.random()*((short?TORCH_CFG.lifeMax*0.7:TORCH_CFG.lifeMax)-TORCH_CFG.lifeMin))*1000,
      hue:TORCH_CFG.baseHue+(Math.random()*TORCH_CFG.hueJitter*2-TORCH_CFG.hueJitter),seed:Math.random()*1000,half:Math.random()<0.45})
  }
  for(let i=0;i<TORCH_CFG.baseParticles;i++)spawn(W/2,H/2);
  function coreGrad(x,y,r,h,a){const g=ctx.createRadialGradient(x,y,0,x,y,r);
    g.addColorStop(0,`hsla(${h-3},90%,95%,${0.85+a*0.12})`);
    g.addColorStop(.35,`hsla(${h+6},94%,68%,${0.62+a*0.12})`);
    g.addColorStop(1,`hsla(${h+12},98%,55%,${0.22+a*0.10})`);return g}
  function loop(t){
    const dt=t-last;if(dt<minDT){requestAnimationFrame(loop);return}last=t;ctx.clearRect(0,0,W,H);
    const cx=W/2+Math.sin(t*TORCH_CFG.driftSpeed+driftPX)*TORCH_CFG.driftAmpX*(1+boost*0.15);
    const cy=H/2+Math.cos(t*TORCH_CFG.driftSpeed*1.1+driftPY)*TORCH_CFG.driftAmpY*(1+boost*0.15);
    const breathAmp=boost>0.1?TORCH_CFG.breathAmpBoost:TORCH_CFG.breathAmpBase;
    const breath=1+Math.sin(t/(boost>0.1?1000:1400))*breathAmp;
    const target=TORCH_CFG.baseParticles+Math.round(boost*TORCH_CFG.boostParticles);
    while(parts.length<target)spawn(cx,cy,boost>0.3);
    boost=Math.max(0,boost-dt/2500);
    ctx.globalCompositeOperation="lighter";
    const bgR=56*breath*(1+boost*0.3),g=ctx.createRadialGradient(cx,cy+14,0,cx,cy+14,bgR);
    g.addColorStop(0,`rgba(255,235,200,${0.10+boost*0.06})`);g.addColorStop(1,"rgba(255,156,61,0)");ctx.fillStyle=g;ctx.beginPath();ctx.arc(cx,cy+14,bgR,0,TWO);ctx.fill();
    for(let i=0;i<parts.length;i++){
      const p=parts[i];p.life+=dt;if(p.life>p.maxLife||p.y<18||p.x<6||p.x>W-6){parts[i]=parts[parts.length-1];parts.pop();i--;continue}
      if(!(p.half&&(Math.floor(t/1000*TORCH_CFG.targetFPS)%2))){
        const dx=cx-p.x,dy=cy-p.y,dist=Math.hypot(dx,dy)+1e-3;const k=1+boost*0.6;
        p.vx+=(dx/dist)*0.002*k; p.vy+=(dy/dist)*0.001*k;
        const swirlK=1+boost*0.5; const n=Math.sin((t+p.seed)/900);
        p.vx+=n*0.003*swirlK; p.vy+=-TORCH_CFG.rise*0.6*k;
        const vmax=TORCH_CFG.speedMax*(1+boost*0.5),sp=Math.hypot(p.vx,p.vy);
        if(sp>vmax){p.vx*=vmax/sp;p.vy*=vmax/sp}
        p.x+=p.vx; p.y+=p.vy;
      }
      const k2=p.life/p.maxLife,h=p.hue+k2*10,a=boost*TORCH_CFG.maxBrightBoost,sz=1+a*0.3,r=p.size*6*breath*sz;
      ctx.fillStyle=coreGrad(p.x,p.y,r,h,a);ctx.beginPath();ctx.arc(p.x,p.y,p.size*breath*sz,0,TWO);ctx.fill();
      if(Math.random()<0.009+boost*0.01){ctx.fillStyle=`hsla(${h},100%,82%,${0.6+a*0.3})`;ctx.beginPath();ctx.arc(p.x,p.y,(p.size+1.6)*breath*sz,0,TWO);ctx.fill()}
    }
    if(parts.length>target)parts.length=Math.max(target,parts.length-1);
    requestAnimationFrame(loop)
  }
  requestAnimationFrame(loop)
})();

/* ===== controls ===== */
$("#startBtn").onclick=startSession;
$("#pauseBtn").onclick=()=> currentState==='paused'?resumeSession():pauseSession();
$("#stopBtn").onclick=()=>stopSession(false);


/* Service Worker ç™»éŒ²ã®è¿½åŠ  */
if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js', { scope: './' }) .then((reg) => { console.log('Service Worker registered: ', reg); }) .catch((err) => { console.log('Service Worker registration failed: ', err); }); }); }


/* init */
$("#counter").textContent="00:00:00";
$("#taskInput").value="";
$("#remain").textContent="â€”";
renderLogs();
</script>
</body>
</html>
